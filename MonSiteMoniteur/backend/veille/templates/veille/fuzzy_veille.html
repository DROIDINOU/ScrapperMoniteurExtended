{% extends 'veille/base.html' %}

{% block content %}

<div class="container py-4">
    <h2 class="mb-3 text-primary text-center">Veille par filtres</h2>
    <p class="text-muted text-center">
        Configurez vos crit√®res. D√®s qu‚Äôune d√©cision judiciaire correspond, une alerte est cr√©√©e.
    </p>

    <!-- Formulaire centr√© -->
    <form method="POST" action="{% url 'veille_fuzzy' %}" class="mx-auto" style="max-width: 500px;" id="veilleForm">
        {% csrf_token %}

        <!-- NOM DE LA VEILLE -->
        <div class="form-group mb-3">
            <label><strong>Nom de votre veille</strong></label>
            <input type="text"
                   name="veille_nom"
                   class="form-control form-control-sm"
                   placeholder="ex : Suivi proc√©dures Charleroi"
                   id="veille_nom">
        </div>

        <!-- ACCORD√âON FILTRES -->
        <div class="accordion" id="filtersAccordion">
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingFilters">
                    <button class="accordion-button" type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapseFilters">
                        Ajouter des filtres
                    </button>
                </h2>

                <div id="collapseFilters" class="accordion-collapse collapse">
                    <div class="accordion-body">

                        <!-- Filtre Type de d√©cision -->
                        <div class="form-group mb-3">
                            <label for="decision_type">Type de d√©cision</label>
                            <select id="decision_type" name="decision_type" class="form-control form-control-sm">
                                <option value="">S√©lectionnez un type de d√©cision</option>
                                <option value="faillite">Faillite</option>
                                <option value="rapportee">Faillite rapport√©e</option>
                                <option value="radiation">Radiation</option>
                                <option value="dissolution">Dissolution</option>
                                <option value="liquidation">Liquidation</option>
                                <option value="condamnation">Condamnation</option>
                                <option value="ouverture">Ouverture</option>
                                <option value="cloture">Cl√¥ture</option>
                            </select>
                        </div>

                        <!-- Filtre Date de publication -->
                        <div class="form-group mb-3">
                            <label for="date_from">Date de publication (d√©but)</label>
                            <input type="date" id="date_from" name="date_from" class="form-control form-control-sm">
                        </div>

                        <!-- Filtre Rue pr√©cise -->
                        <div class="form-group mb-3">
                            <label for="rue">Rue (nom exact ou partiel)</label>
                            <input type="text"
                                   id="rue"
                                   name="rue"
                                   placeholder="ex : Rue de Birmingham"
                                   class="form-control form-control-sm">
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- BOUTONS -->
        <div class="d-flex justify-content-between mt-3 flex-wrap" id="btnContainer">

            <button type="button" id="validateBtn"
                    class="btn btn-primary btn-sm"
                    style="width: 40%;">
                Valider
            </button>

            <button type="button" id="resetBtn"
                    class="btn btn-danger btn-sm"
                    style="width: 40%; display:none;">
                R√©initialiser
            </button>

            <button type="submit" id="submitButton"
                    class="btn btn-success btn-sm"
                    style="width: 40%; cursor: not-allowed;"
                    disabled>
                Enregistrer la veille
            </button>

        </div>

        <div class="alert alert-info mt-2 text-center">
            üìä Les r√©sultats appara√Ætront automatiquement dans votre tableau de bord.
        </div>

    </form>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {

    const validateBtn = document.getElementById("validateBtn");
    const submitButton = document.getElementById("submitButton");

    const veilleNom = document.getElementById("veille_nom");
    const decisionType = document.querySelector("select[name='decision_type']");
    const dateFrom = document.querySelector("input[name='date_from']");
    const rueField = document.querySelector("input[name='rue']");

    let resetBtn = document.getElementById("resetBtn");

    function lockForm() {

        if (veilleNom) { veilleNom.readOnly = true; veilleNom.style.pointerEvents = "none"; }
        if (decisionType) { decisionType.readOnly = true; decisionType.style.pointerEvents = "none"; }
        if (dateFrom) { dateFrom.readOnly = true; dateFrom.style.pointerEvents = "none"; }
        if (rueField) { rueField.readOnly = true; rueField.style.pointerEvents = "none"; }

        validateBtn.style.display = "none";
        resetBtn.style.display = "inline-block";

        submitButton.disabled = false;
        submitButton.style.cursor = "pointer";
    }

    function resetForm() {

        veilleNom.readOnly = false;
        decisionType.disabled = false;
        dateFrom.disabled = false;
        rueField.disabled = false;

        veilleNom.value = "";
        decisionType.value = "";
        dateFrom.value = "";
        rueField.value = "";

        validateBtn.style.display = "inline-block";
        resetBtn.style.display = "none";

        submitButton.disabled = true;
        submitButton.style.cursor = "not-allowed";
    }

    function validateFields() {
        let ok = true;
        let error = "";

        if (veilleNom.value.length > 50) {
            ok = false;
            error = "Le nom de la veille ne doit pas d√©passer 50 caract√®res.";
            veilleNom.value = "";
        }

        if (!ok) {
            alert(error);
            submitButton.disabled = true;
            return;
        }

        lockForm();
    }

    validateBtn.addEventListener("click", validateFields);
    resetBtn.addEventListener("click", resetForm);

    window.addEventListener("pageshow", function (event) {
        if (event.persisted) resetForm();
    });
});
</script>
{% endblock %}
