{% extends 'veille/base.html' %}

{% block content %}
<div class="container-fluid">
    <h1 class="h3 mb-4 text-gray-800 text-center">Configurer votre veille juridique</h1>

    <div class="row">
        <div class="col-md-8 offset-md-2">

            <div class="card shadow mb-4">

                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">Ajoutez les soci√©t√©s √† surveiller</h6>
                </div>

                <div class="card-body">

                    <p class="mb-3">
                        ‚ö° <strong>Copiez-collez</strong> une liste de num√©ros de TVA belge. Vous pouvez les entrer avec ou sans "BE", avec ou sans espaces, points ou tirets.
                    </p>

                    <form id="veilleForm" method="POST" action="{% url 'maveille' %}">
                        {% csrf_token %}

                        <!-- NOM VEILLE -->
                        <label class="font-weight-bold">Nom de la veille</label>
                        <input type="text" name="nom_veille" class="form-control mb-3" placeholder="Exemple : Clients sensibles ‚Äî Novembre 2025">

                        <!-- ZONE DE COLLAGE -->
                        <label class="font-weight-bold">Num√©ros TVA √† surveiller</label>
                        <textarea id="bulkInput" rows="8" class="form-control font-weight-bold" placeholder="Collez ici vos num√©ros TVA (format libre)‚Ä¶" style="white-space: pre;"></textarea>

                        <!-- CHAMP CACH√â ENVOY√â √Ä DJANGO -->
                        <input type="hidden" id="tva_clean_hidden" name="tva_list">

                        <small class="form-text text-muted mt-2">Formats accept√©s : BE 0123456789 ‚Äî 0123456789 ‚Äî BE 012.345.6789 ‚Äî 012-345-6789</small>

                        <!-- RESULTATS TVA VALIDES -->
                        <div id="cleanResult" class="alert alert-info mt-3" style="display:none;"></div>

                        <!-- RESULTATS TVA INVALIDES -->
                        <div id="invalidResults" class="alert alert-danger mt-3" style="display:none;">
                            <strong>Num√©ros TVA invalides :</strong>
                            <div id="invalidNumbersList"></div>
                        </div>

                        <!-- BOUTONS -->
                        <div class="d-flex justify-content-between mt-3">
                            <button type="button" class="btn btn-primary flex-fill me-2" id="validateBtn">Valider les num√©ros TVA</button>
                            <button type="button" class="btn btn-danger flex-fill me-2" id="resetBtn">R√©initialiser</button>
                            <button type="submit" class="btn btn-success flex-fill" id="submitBtn" style="display:none;">Enregistrer veille sur num√©ros valid√©s</button>
                        </div>

                    </form>

                    <hr>
                </div>
            </div>

            <div class="alert alert-info mt-3 text-center">
                üìä Les r√©sultats appara√Ætront automatiquement dans votre tableau de bord.
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const validateBtn = document.getElementById("validateBtn");
    const submitBtn = document.getElementById("submitBtn");
    const bulkInput = document.getElementById("bulkInput");
    const cleanResult = document.getElementById("cleanResult");
    const invalidResults = document.getElementById("invalidResults");
    const invalidNumbersList = document.getElementById("invalidNumbersList");
    const hiddenInput = document.getElementById("tva_clean_hidden");

    function extraireTVA(text) {
        if (!text) return [];
        let t = text.replace(/(?=BE\d)/gi, ' ')
                    .replace(/[.\-]/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim();
        const re = /(?:BE\s*)?((?:\d\s*){10})/gi;
        const found = [];
        let m;
        while ((m = re.exec(t)) !== null) {
            const num = m[1].replace(/\s+/g, '');
            if (num.length === 10) found.push("BE" + num);
        }
        return Array.from(new Set(found));
    }



    validateBtn.addEventListener("click", function () {
        const text = bulkInput.value;
        const tvas = extraireTVA(text);

        const validNumbers = [];
        const invalidNumbers = [];

        tvas.forEach(tva => {
            const num10 = tva.slice(2);
            if (num10.length === 10  && num10 !== "0000000000") {
                validNumbers.push(tva);
            } else {
                invalidNumbers.push(tva);
            }
        });

        if (tvas.length === 0) {
            alert("Aucun num√©ro de TVA d√©tect√©.");
            return;
        }

        if (validNumbers.length > 0) {
            cleanResult.style.display = "block";
            cleanResult.innerHTML = `<strong>Num√©ros TVA valid√©s :</strong><br>${validNumbers.join("<br>")}`;
            submitBtn.style.display = "block";
            hiddenInput.value = validNumbers.join(" "); // IMPORTANT
        } else {
            cleanResult.style.display = "block";
            cleanResult.innerHTML = "<strong>Aucun num√©ro TVA valide d√©tect√©.</strong>";
            submitBtn.style.display = "none";
            hiddenInput.value = "";
        }

        if (invalidNumbers.length > 0) {
            invalidResults.style.display = "block";
            invalidNumbersList.innerHTML = invalidNumbers.join("<br>");
        } else {
            invalidResults.style.display = "none";
        }

        validateBtn.style.display = "none";
        bulkInput.readOnly = true;
    });

    document.getElementById("resetBtn").addEventListener("click", function () {
        bulkInput.value = "";
        bulkInput.readOnly = false;
        cleanResult.style.display = "none";
        invalidResults.style.display = "none";
        submitBtn.style.display = "none";
        validateBtn.style.display = "block";
        hiddenInput.value = "";
    });
});
</script>
{% endblock %}