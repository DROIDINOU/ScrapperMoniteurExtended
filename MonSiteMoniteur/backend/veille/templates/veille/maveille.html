{% extends 'veille/base.html' %}

{% block content %}
<div class="container-fluid">
    <h1 class="h3 mb-4 text-gray-800 text-center">Configurer votre veille juridique</h1>

    <div class="row">
        <div class="col-md-8 offset-md-2">

            <div class="card shadow mb-4">

                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">Ajoutez les sociétés à surveiller</h6>
                </div>

                <div class="card-body">

                    <p class="mb-3">
                        ⚡ <strong>Copiez-collez</strong> une liste de numéros de TVA depuis Excel ou un email.
                        Nous détectons automatiquement les numéros et les nettoyons.
                    </p>

                    <form id="veilleForm" method="POST" action="{% url 'maveille' %}">
                        {% csrf_token %}

                        <!-- ✅ NOUVEAU : nom personnalisé de la veille -->
                        <label class="font-weight-bold">Nom de la veille</label>
                        <input type="text" name="nom_veille" class="form-control mb-3" placeholder="Exemple : Clients sensibles — Novembre 2025">

                        <!-- ✅ Zone de collage intelligente -->
                        <label class="font-weight-bold">Numéros TVA à surveiller</label>
                        <textarea id="bulkInput" name="tva_list" rows="8" class="form-control font-weight-bold" placeholder="Collez ici vos numéros TVA (format libre)…" style="white-space: pre;"></textarea>

                        <small class="form-text text-muted mt-2">
                            Formats acceptés : 0751.149.489 — BE 0751149489 — 751149489
                        </small>

                        <!-- ✅ Liste des TVA nettoyées -->
                        <div id="cleanResult" class="alert alert-info mt-3" style="display:none;"></div>

                        <!-- ✅ Liste des TVA invalides -->
                        <div id="invalidResults" class="alert alert-danger mt-3" style="display:none;">
                            <strong>Numéros TVA invalides :</strong>
                            <div id="invalidNumbersList"></div>
                        </div>

                        <!-- ✅ Boutons de validation et réinitialisation -->
<div class="d-flex justify-content-between">
    <button type="button" class="btn btn-primary btn-block mt-3 w-48" id="validateBtn">Valider les numéros TVA</button>
    <button type="button" class="btn btn-danger btn-block mt-3 w-48" id="resetBtn" style="display:none;">Réinitialiser</button>
</div>
                    </form>

                    <hr>

                    <p class="text-center text-muted small">
                        Vous pourrez suivre : changements d’adresse, d’administrateurs et publications officielles.
                    </p>
                </div>
            </div>

            <div class="text-center mt-2">
                <a href="{% url 'veille_fuzzy' %}" class="btn btn-success btn-sm">
                    Configurer ma veille par mots-clés
                </a>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const validateBtn = document.getElementById("validateBtn");
    const resetBtn = document.getElementById("resetBtn");
    const submitBtn = document.getElementById("submitBtn");
    const bulkInput = document.getElementById("bulkInput");
    const cleanResult = document.getElementById("cleanResult");
    const invalidResults = document.getElementById("invalidResults");
    const invalidNumbersList = document.getElementById("invalidNumbersList");

    // Lorsque l'utilisateur clique sur "Valider TVA"
    validateBtn.addEventListener("click", function () {
        console.log("Validation des numéros de TVA a démarré...");
        const text = bulkInput.value;

        // Expression régulière améliorée pour capturer tous les formats acceptés
        const matches = text.match(/(?:BE\s?)?\d{10}/g); // Recherche tous les numéros de 10 chiffres

        // Si aucun numéro n'est trouvé
        if (!matches) {
            alert("Aucun numéro de TVA valide détecté. Veuillez vérifier le format des numéros.");

            bulkInput.value = "";
            cleanResult.style.display = "none";
            invalidResults.style.display = "none";
            submitBtn.style.display = "none"; // Masquer le bouton "Lancer la veille"
            validateBtn.style.display = "block"; // Réafficher le bouton de validation
            console.log("Aucun numéro de TVA détecté.");
            return;
        }

        // Validation des numéros
        const validNumbers = [];
        const invalidNumbers = [];

        matches.forEach(num => {
            let cleanedNum = num.replace(/[\.\s]/g, "");
            if (cleanedNum.length === 10) {
                validNumbers.push(cleanedNum);
            } else {
                invalidNumbers.push(num);
            }
        });

        if (invalidNumbers.length > 0) {
            cleanResult.style.display = "none";
            invalidResults.style.display = "block";
            invalidNumbersList.innerHTML = invalidNumbers.join("<br>");
            submitBtn.style.display = "none";
            validateBtn.style.display = "none"; // Masquer le bouton "Valider"
            resetBtn.style.display = "block";  // Afficher le bouton "Réinitialiser"
            console.log("Numéros invalides détectés.");
        } else {
            cleanResult.style.display = "block";
            cleanResult.innerHTML = `<strong>Numéros TVA validés :</strong><br>${validNumbers.join("<br>")}`;
            invalidResults.style.display = "none";
            submitBtn.style.display = "block";
            validateBtn.style.display = "none";
            resetBtn.style.display = "block";  // Afficher le bouton "Réinitialiser"
            console.log("Tous les numéros de TVA sont valides.");
        }
    });

    // Fonction de réinitialisation
    resetBtn.addEventListener("click", function () {
        bulkInput.value = "";
        cleanResult.style.display = "none";
        invalidResults.style.display = "none";
        submitBtn.style.display = "none";
        validateBtn.style.display = "block";
        resetBtn.style.display = "none"; // Masquer le bouton "Réinitialiser" après réinitialisation
        invalidNumbersList.innerHTML = "";
        console.log("Réinitialisation des résultats.");
    });
});

</script>
{% endblock %}
