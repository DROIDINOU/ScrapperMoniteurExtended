{% extends 'veille/base.html' %}

{% block content %}
<div class="container-fluid">
    <h1 class="h3 mb-4 text-gray-800 text-center">Configurer votre veille juridique</h1>

    <div class="row">
        <div class="col-md-8 offset-md-2">

            <div class="card shadow mb-4">

                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">Ajoutez les soci√©t√©s √† surveiller</h6>
                </div>

                <div class="card-body">

                    <p class="mb-3">
                        ‚ö° <strong>Copiez-collez</strong> une liste de num√©ros de TVA depuis Excel ou un email.
                        Nous d√©tectons automatiquement les num√©ros et les nettoyons.
                    </p>

                    <form id="veilleForm" method="POST" action="{% url 'maveille' %}">
                        {% csrf_token %}

                        <!-- ‚úÖ NOUVEAU : nom personnalis√© de la veille -->
                        <label class="font-weight-bold">Nom de la veille</label>
                        <input type="text" name="nom_veille" class="form-control mb-3" placeholder="Exemple : Clients sensibles ‚Äî Novembre 2025">

                        <!-- ‚úÖ Zone de collage intelligente -->
                        <label class="font-weight-bold">Num√©ros TVA √† surveiller</label>
                        <textarea id="bulkInput" name="tva_list" rows="8" class="form-control font-weight-bold" placeholder="Collez ici vos num√©ros TVA (format libre)‚Ä¶" style="white-space: pre;"></textarea>

                        <small class="form-text text-muted mt-2">
                            Formats accept√©s : 0751.149.489 ‚Äî BE 0751149489 ‚Äî 751149489
                        </small>

                        <!-- ‚úÖ Liste des TVA nettoy√©es -->
                        <div id="cleanResult" class="alert alert-info mt-3" style="display:none;"></div>

                        <!-- ‚úÖ Liste des TVA invalides -->
                        <div id="invalidResults" class="alert alert-danger mt-3" style="display:none;">
                            <strong>Num√©ros TVA invalides :</strong>
                            <div id="invalidNumbersList"></div>
                        </div>

                        <!-- ‚úÖ Boutons de validation et lancement -->
                        <button type="button" class="btn btn-primary btn-block mt-3" id="validateBtn">Valider les num√©ros TVA</button>
                        <button type="submit" class="btn btn-success btn-block mt-3" id="submitBtn" style="display:none;">üöÄ Lancer la veille</button>
                    </form>

                    <hr>

                    <p class="text-center text-muted small">
                        Vous pourrez suivre : changements d‚Äôadresse, d‚Äôadministrateurs et publications officielles.
                    </p>
                </div>
            </div>

            <div class="text-center mt-2">
                <a href="{% url 'veille_fuzzy' %}" class="btn btn-success btn-sm">
                    Configurer ma veille par mots-cl√©s
                </a>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    console.log("DOM enti√®rement charg√©.");

    const validateBtn = document.getElementById("validateBtn");
    const submitBtn = document.getElementById("submitBtn");
    const bulkInput = document.getElementById("bulkInput");
    const cleanResult = document.getElementById("cleanResult");
    const invalidResults = document.getElementById("invalidResults");
    const invalidNumbersList = document.getElementById("invalidNumbersList");

    // Fonction de nettoyage et validation des num√©ros
    bulkInput.addEventListener("input", function () {
        let cleanedValue = bulkInput.value.replace(/\s+/g, " ");  // Remplacer les espaces multiples par un seul espace
        cleanedValue = cleanedValue.replace(/^BE\s?/i, ""); // Supprimer "BE" au d√©but si pr√©sent
        bulkInput.value = cleanedValue;
    });

    // Lorsque l'utilisateur clique sur "Valider TVA"
    validateBtn.addEventListener("click", function () {
        console.log("Validation des num√©ros de TVA a d√©marr√©...");
        const text = bulkInput.value;
        console.log("Texte coll√© : ", text);

        // Expression r√©guli√®re am√©lior√©e pour capturer tous les formats accept√©s
        const matches = text.match(/(?:BE\s?)?\d{10}/g); // Recherche tous les num√©ros de 10 chiffres

        // Si aucun num√©ro n'est trouv√©
        if (!matches) {
            // Afficher un popup si aucun num√©ro n'est trouv√©
            alert("Aucun num√©ro de TVA valide d√©tect√©. Veuillez v√©rifier le format des num√©ros.");

            // R√©initialiser le champ de saisie
            bulkInput.value = "";
            cleanResult.style.display = "none";
            invalidResults.style.display = "none";
            submitBtn.style.display = "none"; // Masquer le bouton "Lancer la veille"
            validateBtn.style.display = "block"; // R√©afficher le bouton de validation
            console.log("Aucun num√©ro de TVA d√©tect√©.");
            return;
        }

        console.log("Num√©ros d√©tect√©s : ", matches);

        // Validation des num√©ros
        const validNumbers = [];
        const invalidNumbers = [];

        matches.forEach(num => {
            // Nettoyage des num√©ros : retirer les points et espaces
            let cleanedNum = num.replace(/[\.\s]/g, "");
            console.log("Num√©ro nettoy√© : ", cleanedNum);

            // Validation (on accepte les num√©ros de 10 chiffres)
            if (cleanedNum.length === 10) {
                validNumbers.push(cleanedNum);
            } else {
                invalidNumbers.push(num);
            }
        });

        // Affichage des r√©sultats
        if (invalidNumbers.length > 0) {
            // Si des num√©ros sont invalides
            cleanResult.style.display = "none"; // Masquer les num√©ros valides
            invalidResults.style.display = "block"; // Afficher les num√©ros invalides
            invalidNumbersList.innerHTML = invalidNumbers.join("<br>");  // Afficher les num√©ros invalides
            submitBtn.style.display = "none"; // Masquer le bouton "Lancer la veille"
            validateBtn.style.display = "none"; // Masquer le bouton "Valider"
            console.log("Num√©ros invalides d√©tect√©s.");
        } else {
            // Si tous les num√©ros sont valides
            cleanResult.style.display = "block"; // Afficher les r√©sultats des num√©ros valides
            cleanResult.innerHTML = `<strong>Num√©ros TVA valid√©s :</strong><br>${validNumbers.join("<br>")}`; // Changer le texte √† "valid√©s"
            invalidResults.style.display = "none"; // Masquer les num√©ros invalides
            submitBtn.style.display = "block"; // Afficher le bouton "Lancer la veille"
            validateBtn.style.display = "none"; // Cacher le bouton "Valider" apr√®s validation
            console.log("Tous les num√©ros de TVA sont valides.");
        }
    });

    // Fonction de r√©initialisation
    const resetBtn = document.createElement("button");
    resetBtn.innerHTML = "R√©initialiser";
    resetBtn.classList.add("btn", "btn-danger", "btn-block", "mt-3");
    resetBtn.addEventListener("click", function () {
        bulkInput.value = "";
        cleanResult.style.display = "none";
        invalidResults.style.display = "none";
        submitBtn.style.display = "none";
        validateBtn.style.display = "block";
        invalidNumbersList.innerHTML = "";
        console.log("R√©initialisation des r√©sultats.");
    });

    // Ajouter le bouton de r√©initialisation √† la page apr√®s validation
    document.querySelector(".card-body").appendChild(resetBtn);

});
</script>
{% endblock %}
