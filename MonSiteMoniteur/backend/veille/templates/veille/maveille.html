{% extends 'veille/base.html' %}

{% block content %}
<div class="container-fluid">
    <h1 class="h3 mb-4 text-gray-800 text-center">Configurer votre veille juridique</h1>

    <div class="row">
        <div class="col-md-8 offset-md-2">

            <div class="card shadow mb-4">

                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">Ajoutez les soci√©t√©s √† surveiller</h6>
                </div>

                <div class="card-body">

                    <p class="mb-3">
                        ‚ö° <strong>Copiez-collez</strong> une liste de num√©ros de TVA belge. Vous pouvez les entrer avec ou sans "BE", avec ou sans espaces, points ou tirets.
                    </p>

                    <form id="veilleForm" method="POST" action="{% url 'maveille' %}">
                        {% csrf_token %}

                        <!-- ‚úÖ NOUVEAU : nom personnalis√© de la veille -->
                        <label class="font-weight-bold">Nom de la veille</label>
                        <input type="text" name="nom_veille" class="form-control mb-3" placeholder="Exemple : Clients sensibles ‚Äî Novembre 2025">

                        <!-- ‚úÖ Zone de collage intelligente -->
                        <label class="font-weight-bold">Num√©ros TVA √† surveiller</label>
                        <textarea id="bulkInput" name="tva_list" rows="8" class="form-control font-weight-bold" placeholder="Collez ici vos num√©ros TVA (format libre)‚Ä¶" style="white-space: pre;"></textarea>

                        <small class="form-text text-muted mt-2">
                            Formats accept√©s : BE 0123456789 ‚Äî 0123456789 ‚Äî BE 012.345.6789 ‚Äî 012-345-6789
                        </small>

                        <!-- ‚úÖ Liste des TVA nettoy√©es -->
                        <div id="cleanResult" class="alert alert-info mt-3" style="display:none;"></div>

                        <!-- ‚úÖ Liste des TVA invalides -->
                        <div id="invalidResults" class="alert alert-danger mt-3" style="display:none;">
                            <strong>Num√©ros TVA invalides :</strong>
                            <div id="invalidNumbersList"></div>
                        </div>

                        <!-- ‚úÖ Boutons de validation et lancement -->
                        <div class="d-flex justify-content-between mt-3">
                            <button type="button" class="btn btn-primary" id="validateBtn" style="width: 48%;">Valider les num√©ros TVA</button>
                            <button type="button" class="btn btn-danger" id="resetBtn" style="width: 48%;">R√©initialiser</button>
                        </div>

                        <!-- Bouton de soumission cach√© -->
                        <button type="submit" class="btn btn-success btn-block mt-3" id="submitBtn" style="display:none;">üöÄ Lancer la veille</button>

                    </form>

                    <hr>

                    <div class="text-center mt-2">
                <a href="{% url 'veille_fuzzy' %}" class="btn btn-success btn-sm">
                    Configurer ma veille par mots-cl√©s
                </a>
            </div>
                </div>
            </div>

<div class="alert alert-info mt-3 text-center">
        üìä Les r√©sultats appara√Ætront automatiquement dans votre tableau de bord.
    </div>

        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    console.log("DOM enti√®rement charg√©.");

    const validateBtn = document.getElementById("validateBtn");
    const submitBtn = document.getElementById("submitBtn");
    const bulkInput = document.getElementById("bulkInput");
    const cleanResult = document.getElementById("cleanResult");
    const invalidResults = document.getElementById("invalidResults");
    const invalidNumbersList = document.getElementById("invalidNumbersList");

    // Fonction de nettoyage et validation des num√©ros
    bulkInput.addEventListener("input", function () {
        let cleanedValue = bulkInput.value.replace(/\s+/g, " ");  // Remplacer les espaces multiples par un seul espace
        bulkInput.value = cleanedValue;
    });

    // Lorsque l'utilisateur clique sur "Valider TVA"
    validateBtn.addEventListener("click", function () {
        console.log("Validation des num√©ros de TVA a d√©marr√©...");
        const text = bulkInput.value;
        console.log("Texte coll√© : ", text);

        // S√©parer les num√©ros par espace ou nouvelle ligne
        const lines = text.split(/\s+/); // S√©pare les num√©ros par espaces ou nouvelles lignes
        console.log("Num√©ros s√©par√©s : ", lines);

        // Expression r√©guli√®re pour capturer les num√©ros de TVA belge avec ou sans BE, avec ou sans tirets et points
        const regex = /\b(?:BE\s?)?(\d{3}[-.]?\d{3}[-.]?\d{4})\b/g;

        // Initialisation des listes
        const validNumbers = [];
        const invalidNumbers = [];

        // Validation des num√©ros
        lines.forEach(line => {
            let matches = line.match(regex);  // Recherche dans chaque ligne s√©par√©e
            if (matches) {
                matches.forEach(num => {
                    let cleanedNum = num.replace(/[\.\-\s]/g, "");  // Enlever les points, tirets et espaces
                    console.log("Num√©ro nettoy√© : ", cleanedNum);

                    // Validation (le num√©ro doit avoir 10 chiffres)
                    if (cleanedNum.length === 10) {
                        validNumbers.push(cleanedNum);
                    } else {
                        invalidNumbers.push(num);
                    }
                });
            }
        });

        // Affichage des r√©sultats
        if (invalidNumbers.length > 0) {
            cleanResult.style.display = "none";
            invalidResults.style.display = "block";
            invalidNumbersList.innerHTML = invalidNumbers.join("<br>");
            submitBtn.style.display = "none";
            validateBtn.style.display = "none";
            console.log("Num√©ros invalides d√©tect√©s.");
        } else {
            cleanResult.style.display = "block";
            cleanResult.innerHTML = `<strong>Num√©ros TVA valid√©s :</strong><br>${validNumbers.join("<br>")}`;
            invalidResults.style.display = "none";
            submitBtn.style.display = "block";
            validateBtn.style.display = "none";
            console.log("Tous les num√©ros de TVA sont valides.");
        }
    });

    // Fonction de r√©initialisation
    const resetBtn = document.getElementById("resetBtn");
    resetBtn.addEventListener("click", function () {
        bulkInput.value = "";
        cleanResult.style.display = "none";
        invalidResults.style.display = "none";
        submitBtn.style.display = "none";
        validateBtn.style.display = "block";
        invalidNumbersList.innerHTML = "";
        console.log("R√©initialisation des r√©sultats.");
    });

});
</script>
{% endblock %}
