{% extends 'veille/base.html' %}

{% block content %}
<div class="container-fluid">
    <h1 class="h3 mb-4 text-gray-800 text-center">Configurer votre veille juridique</h1>

    <div class="row">
        <div class="col-md-8 offset-md-2">

            <div class="card shadow mb-4">

                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">Ajoutez les soci√©t√©s √† surveiller</h6>
                </div>

                <div class="card-body">

                    <p class="mb-3">
                        ‚ö° <strong>Copiez-collez</strong> une liste de num√©ros de TVA belge. Vous pouvez les entrer avec ou sans "BE", avec ou sans espaces, points ou tirets.
                    </p>

                    <form id="veilleForm" method="POST" action="{% url 'maveille' %}">
                        {% csrf_token %}

                        <!-- ‚úÖ NOUVEAU : nom personnalis√© de la veille -->
                        <label class="font-weight-bold">Nom de la veille</label>
                        <input type="text" name="nom_veille" class="form-control mb-3" placeholder="Exemple : Clients sensibles ‚Äî Novembre 2025">

                        <!-- ‚úÖ Zone de collage intelligente -->
                        <label class="font-weight-bold">Num√©ros TVA √† surveiller</label>
                        <textarea id="bulkInput" name="tva_list" rows="8" class="form-control font-weight-bold" placeholder="Collez ici vos num√©ros TVA (format libre)‚Ä¶" style="white-space: pre;"></textarea>

                        <small class="form-text text-muted mt-2">
                            Formats accept√©s : BE 0123456789 ‚Äî 0123456789 ‚Äî BE 012.345.6789 ‚Äî 012-345-6789
                        </small>

                        <!-- ‚úÖ Liste des TVA nettoy√©es -->
                        <div id="cleanResult" class="alert alert-info mt-3" style="display:none;"></div>

                        <!-- ‚úÖ Liste des TVA invalides -->
                        <div id="invalidResults" class="alert alert-danger mt-3" style="display:none;">
                            <strong>Num√©ros TVA invalides :</strong>
                            <div id="invalidNumbersList"></div>
                        </div>

                        <!-- ‚úÖ Boutons de validation et lancement -->
                        <div class="d-flex justify-content-between mt-3">
                            <button type="button" class="btn btn-primary flex-fill me-2" id="validateBtn">Valider les num√©ros TVA</button>
    <button type="button" class="btn btn-danger flex-fill me-2" id="resetBtn">R√©initialiser</button>
    <button type="submit" class="btn btn-success flex-fill" id="submitBtn" style="display:none;">Lancer la veille</button>
                        </div>



                    </form>

                    <hr>
                </div>
            </div>

<div class="alert alert-info mt-3 text-center">
        üìä Les r√©sultats appara√Ætront automatiquement dans votre tableau de bord.
    </div>

        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    console.log("DOM enti√®rement charg√©.");

    const validateBtn = document.getElementById("validateBtn");
    const submitBtn = document.getElementById("submitBtn");
    const bulkInput = document.getElementById("bulkInput");
    const cleanResult = document.getElementById("cleanResult");
    const invalidResults = document.getElementById("invalidResults");
    const invalidNumbersList = document.getElementById("invalidNumbersList");

    // --- Extraction TVA ---
    function extraireTVA(text) {
        if (!text) return [];

        let t = text.replace(/(?=BE\d)/gi, ' ')
                    .replace(/[.\-]/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim();

        const re = /(?:BE\s*)?((?:\d\s*){10})/gi;
        const found = [];
        let m;
        while ((m = re.exec(t)) !== null) {
            const num = m[1].replace(/\s+/g, '');
            if (num.length === 10) found.push("BE" + num);
        }

        return Array.from(new Set(found));
    }

    // --- Contr√¥le modulo 97 ---
    function checkMod97(num10) {
        const base = parseInt(num10.slice(0, 8), 10);
        const key = parseInt(num10.slice(8), 10);
        return (97 - (base % 97)) === key;
    }

    // Lorsque l'utilisateur clique sur "Valider TVA"
    validateBtn.addEventListener("click", function () {
        console.log("Validation des num√©ros de TVA a d√©marr√©...");
        const text = bulkInput.value;

        const tvas = extraireTVA(text);
        console.log("TVA extraits :", tvas);

        const validNumbers = [];
        const invalidNumbers = [];

        tvas.forEach(tva => {
            const num10 = tva.slice(2);
            if (num10.length === 10 && num10.startsWith("0") && num10 !== "0000000000" && checkMod97(num10)) {
                validNumbers.push(tva);
            } else {
                invalidNumbers.push(tva);
            }
        });

        // üö® Nouveau : popup si aucun num√©ro d√©tect√©
        if (tvas.length === 0) {
            alert("Aucun num√©ro de TVA n‚Äôa √©t√© d√©tect√©. Veuillez v√©rifier votre saisie.");
            return; // stoppe la fonction ici
        }

        // Affichage des r√©sultats
        if (invalidNumbers.length > 0) {
            cleanResult.style.display = "none";
            invalidResults.style.display = "block";
            invalidNumbersList.innerHTML = invalidNumbers.join("<br>");
            submitBtn.style.display = "none";
            validateBtn.style.display = "none";
            console.log("Num√©ros invalides d√©tect√©s.");
        } else {
            cleanResult.style.display = "block";
            cleanResult.innerHTML = `<strong>Num√©ros TVA valid√©s :</strong><br>${validNumbers.join("<br>")}`;
            invalidResults.style.display = "none";

            if (validNumbers.length > 0) {
                submitBtn.style.display = "block";
                validateBtn.style.display = "none";
            } else {
                submitBtn.style.display = "none";
            }

            console.log("Tous les num√©ros de TVA sont valides.");
        }
    });

    // Fonction de r√©initialisation
    const resetBtn = document.getElementById("resetBtn");
    resetBtn.addEventListener("click", function () {
        bulkInput.value = "";
        cleanResult.style.display = "none";
        invalidResults.style.display = "none";
        submitBtn.style.display = "none";
        validateBtn.style.display = "block";
        invalidNumbersList.innerHTML = "";
        console.log("R√©initialisation des r√©sultats.");
    });

});
</script>
{% endblock %}
